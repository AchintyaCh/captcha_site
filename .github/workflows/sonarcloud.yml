name: CI → SonarCloud (via sonarqube-scan-action)

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    env:
      # defaults; override via repo secrets if needed
      SONAR_PROJECT_KEY: AchintyaCh_captcha_site
      SONAR_HOST_URL: https://sonarcloud.io
      # Optional: set a coverage threshold (in percent) to enforce in the workflow.
      # If not needed, leave empty or remove COVERAGE_THRESHOLD.
      COVERAGE_THRESHOLD: ''   # e.g., "70"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python & run tests (generate coverage.xml)
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Run tests and build coverage
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-cov || true
          pytest --maxfail=1 --disable-warnings -q --cov=. --cov-report=xml || true

      - name: SonarCloud Scan (sonarqube-scan-action)
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          args: >
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.python.coverage.reportPaths=coverage.xml
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Wait for Sonar Quality Gate (poll Sonar API)
        id: wait_quality_gate
        run: |
          set -euo pipefail
          API_URL="${{ env.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${{ env.SONAR_PROJECT_KEY }}"
          echo "Polling Sonar for quality gate status at: $API_URL"

          # Token must be provided via SONAR_TOKEN env (already set above).
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "ERROR: SONAR_TOKEN secret is not set. Set it in repository secrets."
            exit 1
          fi

          # Poll until status is not "IN_PROGRESS" or until timeout
          max_tries=30    # 30 tries * sleep 10s = ~5 minutes total
          sleep_seconds=10
          attempt=0

          while [ $attempt -lt $max_tries ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_tries..."
            http_status=0
            # Use token as basic auth (token:)
            response=$(curl -s -w "\n%{http_code}" -u "${{ secrets.SONAR_TOKEN }}:" "$API_URL")
            # separate body and status
            body=$(echo "$response" | sed '$d')
            http_status=$(echo "$response" | tail -n1)
            if [ "$http_status" != "200" ]; then
              echo "Warning: Sonar API returned HTTP $http_status. Body:"
              echo "$body"
              # keep retrying
            else
              status=$(echo "$body" | jq -r '.projectStatus.status')
              echo "Quality Gate status: $status"
              if [ "$status" = "OK" ]; then
                echo "QUALITY GATE PASSED (OK)."
                echo "::set-output name=status::OK"
                exit 0
              elif [ "$status" = "ERROR" ] || [ "$status" = "WARNING" ] || [ "$status" = "NONE" ]; then
                # ERROR = failed gate, WARNING/NONE = treat as fail depending on policy — fail here
                echo "Quality Gate finished with status: $status"
                echo "$body" | jq '.projectStatus'
                echo "::set-output name=status::$status"
                exit 1
              else
                # IN_PROGRESS or unknown, retry
                echo "Status is '$status' — waiting $sleep_seconds seconds before retry..."
              fi
            fi
            sleep $sleep_seconds
          done

          echo "Timed out waiting for Sonar Quality Gate after $max_tries attempts."
          echo "You can increase max_tries or sleep_seconds if longer analysis times are expected."
          exit 1

      # Optional: enforce a numeric coverage threshold locally (comment / remove if not needed)
      - name: (Optional) Enforce coverage threshold
        if: ${{ env.COVERAGE_THRESHOLD != '' }}
        run: |
          # Fetch coverage via Sonar measures API and fail build if below threshold
          API_MEASURES="${{ env.SONAR_HOST_URL }}/api/measures/component?component=${{ env.SONAR_PROJECT_KEY }}&metricKeys=coverage"
          echo "Fetching coverage from $API_MEASURES"
          response=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" "$API_MEASURES")
          coverage=$(echo "$response" | jq -r '.component.measures[] | select(.metric=="coverage") | .value')
          if [ -z "$coverage" ] || [ "$coverage" = "null" ]; then
            echo "Could not read coverage from Sonar (response: $response). Failing."
            exit 1
          fi
          echo "Coverage reported by Sonar: $coverage%"
          threshold=${{ env.COVERAGE_THRESHOLD }}
          awk -v c="$coverage" -v t="$threshold" 'BEGIN{ if (c+0 < t+0) exit 1; else exit 0 }'
