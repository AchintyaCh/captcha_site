name: CI → SonarCloud (fixed)

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]

env:
  # Default project key used by Sonar; change if you use a different one
  SONAR_PROJECT_KEY: AchintyaCh_captcha_site
  # SonarCloud base URL (do NOT change for SonarCloud)
  SONAR_HOST_URL: https://sonarcloud.io
  # Optional: set to a number (e.g. "70") to enforce coverage threshold after analysis.
  COVERAGE_THRESHOLD: ''   # leave empty to disable

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies & run tests (generate coverage.xml)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-cov || true
          pytest --maxfail=1 --disable-warnings -q --cov=. --cov-report=xml || true

      - name: SonarCloud Scan (sonarqube-scan-action)
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          args: >
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.python.coverage.reportPaths=coverage.xml
        env:
          # must provide token as env var (action will read it)
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Wait for Sonar Quality Gate (poll Sonar API)
        id: wait_quality_gate
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "SONAR_TOKEN secret is missing. Set it in repository secrets."
            exit 1
          fi

          API_URL="${{ env.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${{ env.SONAR_PROJECT_KEY }}"
          echo "Polling Sonar for quality gate status at: $API_URL"

          max_tries=30       # tries
          sleep_seconds=10   # seconds between tries
          attempt=0

          while [ $attempt -lt $max_tries ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_tries..."
            # get body + http code
            response="$(curl -s -w '\n%{http_code}' -u "${{ secrets.SONAR_TOKEN }}:" "$API_URL")"
            body="$(echo "$response" | sed '$d')"
            http_code="$(echo "$response" | tail -n1)"

            if [ "$http_code" != "200" ]; then
              echo "Warning: Sonar API returned HTTP $http_code. Body:"
              echo "$body"
              # retry unless last attempt
            else
              status="$(echo "$body" | jq -r '.projectStatus.status')"
              echo "Quality Gate status: $status"
              if [ "$status" = "OK" ]; then
                echo "Quality Gate PASSED."
                echo "status=$status" >> "$GITHUB_OUTPUT"
                exit 0
              elif [ "$status" = "IN_PROGRESS" ]; then
                echo "Status is IN_PROGRESS — waiting $sleep_seconds seconds before retry..."
              else
                # ERROR, WARNING, NONE, etc. treat as failure
                echo "Quality Gate finished with status: $status"
                echo "Full projectStatus:"
                echo "$body" | jq '.projectStatus'
                echo "status=$status" >> "$GITHUB_OUTPUT"
                exit 1
              fi
            fi

            sleep $sleep_seconds
          done

          echo "Timed out waiting for Sonar Quality Gate after $max_tries attempts."
          exit 1

      - name: (Optional) Enforce coverage threshold from Sonar (disabled if COVERAGE_THRESHOLD empty)
        if: ${{ env.COVERAGE_THRESHOLD != '' }}
        run: |
          set -euo pipefail
          API_MEASURES="${{ env.SONAR_HOST_URL }}/api/measures/component?component=${{ env.SONAR_PROJECT_KEY }}&metricKeys=coverage"
          echo "Fetching coverage from Sonar: $API_MEASURES"
          response="$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" "$API_MEASURES")"
          coverage="$(echo "$response" | jq -r '.component.measures[] | select(.metric=="coverage") | .value')"
          if [ -z "$coverage" ] || [ "$coverage" = "null" ]; then
            echo "Could not read coverage from Sonar (response: $response). Failing."
            exit 1
          fi
          echo "Coverage reported by Sonar: $coverage%"
          threshold=${{ env.COVERAGE_THRESHOLD }}
          awk -v c="$coverage" -v t="$threshold" 'BEGIN{ if (c+0 < t+0) exit 1; else exit 0 }'
